<script>
import { __, sprintf } from '~/locale';
import CiBadgeLink from '~/vue_shared/components/ci_badge_link.vue';
import CiIcon from '~/vue_shared/components/ci_icon.vue';
import Icon from '~/vue_shared/components/icon.vue';
import { GlTooltip } from '@gitlab/ui';
import { STATUS_FAILED } from '../../constants';

export default {
  components: {
    CiBadgeLink,
    CiIcon,
    Icon,
    GlTooltip,
  },
  props: {
    status: {
      type: Object,
      required: true,
    },
    upstreamPipeline: {
      type: Object,
      required: false,
      default: null,
    },
    downstreamPipelines: {
      type: Array,
      required: false,
      default: null,
    },
    hasPipelineFailed: {
      type: Boolean,
      required: false,
      default: false,
    },
  },
  relations: {
    current: __('Current Project'),
    downstream: __('Downstream'),
    upstream: __('Upstream'),
  },
  computed: {
    downstreamPipelinesHaveFailed() {
      return (
        this.downstreamPipelines &&
        this.downstreamPipelines.some(
          pipeline =>
            pipeline.details &&
            pipeline.details.status &&
            pipeline.details.status.group === STATUS_FAILED,
        )
      );
    },
    pipelineClasses() {
      const hasFailures = this.hasPipelineFailed || this.downstreamPipelinesHaveFailed;
      return {
        'ops-dashboard-project-pipeline-failed': hasFailures,
        'bg-light': !hasFailures,
      };
    },
    hasDownstreamPipelines() {
      return this.downstreamPipelines && this.downstreamPipelines.length > 0;
    },
    hasExtraDownstream() {
      return this.downstreamCount > this.shownDownstreamCount;
    },
    shownDownstreamPipelines() {
      // We can only fit 5 statuses in the pipeline section on mobile before we have to truncate
      return this.downstreamPipelines.slice(0, 5);
    },
    shownDownstreamCount() {
      return this.shownDownstreamPipelines.length;
    },
    downstreamCount() {
      return this.downstreamPipelines.length;
    },
    extraDownstreamText() {
      const extra = this.downstreamCount - this.shownDownstreamCount;
      // Only render a plus sign if extra is a single digit
      const plus = extra < 10 ? '+' : '';
      return `${plus}${extra}`;
    },
    extraDownstreamTitle() {
      const extra = this.downstreamCount - this.shownDownstreamCount;

      return sprintf('%{extra} more downstream pipelines', {
        extra,
      });
    },
  },
};
</script>
<template>
  <div :class="pipelineClasses" class="ops-dashboard-project-pipeline py-1 px-2 mt-3">
    <template v-if="upstreamPipeline">
      <a
        ref="upstreamStatus"
        :href="upstreamPipeline.details.status.details_path"
        class="d-inline-block align-middle"
      >
        <ci-icon
          class="d-flex js-upstream-pipeline-status"
          :status="upstreamPipeline.details.status"
        />
      </a>
      <gl-tooltip :target="() => $refs.upstreamStatus">
        <div class="bold">{{ $options.relations.upstream }}</div>
        <div>{{ upstreamPipeline.details.status.tooltip }}</div>
        <div class="text-tertiary">{{ upstreamPipeline.details.name_with_namespace || '' }}</div>
      </gl-tooltip>

      <icon name="arrow-right" class="ops-dashboard-project-pipeline-arrow align-middle mx-1" />
    </template>

    <ci-badge-link ref="status" class="bg-white" :status="status" :show-text="true" />
    <gl-tooltip :target="() => $refs.status">
      <div class="bold">{{ $options.relations.current }}</div>
      <div>{{ status.tooltip }}</div>
    </gl-tooltip>

    <template v-if="hasDownstreamPipelines">
      <icon name="arrow-right" class="ops-dashboard-project-pipeline-arrow align-middle mx-1" />

      <div
        v-for="(pipeline, index) in shownDownstreamPipelines"
        :key="pipeline.id"
        :style="`z-index: ${shownDownstreamPipelines.length + 1 - index}`"
        class="ops-dashboard-project-pipeline-downstream position-relative d-inline"
      >
        <a
          ref="downstreamStatus"
          :href="pipeline.details.status.details_path"
          class="d-inline-block align-middle"
        >
          <ci-icon class="d-flex js-downstream-pipeline-status" :status="pipeline.details.status" />
        </a>
        <gl-tooltip :target="() => $refs.downstreamStatus[index]">
          <div class="bold">{{ $options.relations.downstream }}</div>
          <div>{{ pipeline.details.status.tooltip }}</div>
          <div class="text-tertiary">{{ pipeline.details.name_with_namespace || '' }}</div>
        </gl-tooltip>
      </div>
      <div v-if="hasExtraDownstream" class="d-inline">
        <a
          ref="extraDownstream"
          :href="status.details_path"
          class="ops-dashboard-project-pipeline-extra rounded-circle d-inline-block bold align-middle text-white text-center js-downstream-extra-icon"
        >
          {{ extraDownstreamText }}
        </a>
        <gl-tooltip :target="() => $refs.extraDownstream">
          {{ extraDownstreamTitle }}
        </gl-tooltip>
      </div>
    </template>
  </div>
</template>
